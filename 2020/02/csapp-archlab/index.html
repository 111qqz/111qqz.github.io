<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:site_name" content="111qqz的小窝"><meta property="og:type" content="article"><meta property="og:image" content="https://111qqz.github.io/img/2.png"><meta property="twitter:image" content="https://111qqz.github.io/img/2.png"><meta name=title content="【施工完成】CSAPP archlab"><meta property="og:title" content="【施工完成】CSAPP archlab"><meta property="twitter:title" content="【施工完成】CSAPP archlab"><meta name=description content><meta property="og:description" content><meta property="twitter:description" content><meta property="twitter:card" content="summary"><meta name=keyword content="ACM,111qqz,商汤科技,hust,华中科技大学"><link rel="shortcut icon" href=/img/favicon.ico><title>【施工完成】CSAPP archlab-111qqz的小窝</title><link rel=canonical href=/2020/02/csapp-archlab/><link rel=stylesheet href=/css/iDisqus.min.css><link rel=stylesheet href=/css/bootstrap.min.css><link rel=stylesheet href=/css/hux-blog.min.css><link rel=stylesheet href=/css/syntax.css><link rel=stylesheet href=/css/zanshang.css><link href=//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css rel=stylesheet type=text/css><script src=/js/jquery.min.js></script><script src=/js/bootstrap.min.js></script><script src=/js/hux-blog.min.js></script><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/styles/docco.min.css><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/highlight.min.js></script><script>hljs.initHighlightingOnLoad();</script><link rel=stylesheet href=/css/hux-blog.min.css><link rel=stylesheet href=/css/hux-blog.min-custom.css></head><nav class="navbar navbar-default navbar-custom navbar-fixed-top"><div class=container-fluid><div class="navbar-header page-scroll"><button type=button class=navbar-toggle>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span><span class=icon-bar></span><span class=icon-bar></span></button>
<a class=navbar-brand href=/>111qqz的小窝</a></div><div id=huxblog_navbar><div class=navbar-collapse><ul class="nav navbar-nav navbar-right"><li><a href=/>Home</a></li><li><a href=/categories/acm/>ACM-ICPC</a></li><li><a href=/categories/deep-learning/>深度学习</a></li><li><a href=/categories/mooc/>公开课</a></li><li><a href=/categories/%e5%85%b6%e4%bb%96/>其他</a></li><li><a href=/top/about/>ABOUT</a></li><li><a href=/search>SEARCH <img src=/img/search.png height=15 style=cursor:pointer alt=Search></a></li></ul></div></div></div></nav><script>var $body=document.body;var $toggle=document.querySelector('.navbar-toggle');var $navbar=document.querySelector('#huxblog_navbar');var $collapse=document.querySelector('.navbar-collapse');$toggle.addEventListener('click',handleMagic)
function handleMagic(e){if($navbar.className.indexOf('in')>0){$navbar.className=" ";setTimeout(function(){if($navbar.className.indexOf('in')<0){$collapse.style.height="0px"}},400)}else{$collapse.style.height="auto"
$navbar.className+=" in";}}</script><style type=text/css>header.intro-header{background-image:url(/img/2.png)}</style><header class=intro-header><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=post-heading><div class=tags><a class=tag href=/tags/csapp title=CSAPP>CSAPP</a></div><h1>【施工完成】CSAPP archlab</h1><h2 class=subheading></h2><span class=meta>Posted by
111qqz
on
Wednesday, February 26, 2020
<span id=/2020/02/csapp-archlab/ class="leancloud_visitors meta_data_item" data-flag-title><span class=post-meta-item-icon><span class="octicon octicon-eye"></span></span><i class="fa fa-eye"></i><span class=old-visitors-count style=display:none></span><span class=leancloud-visitors-count></span></span><script src=https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js></script><script>AV.initialize("2dzJwxGKq4hbtg5R5NM8NTzJ-gzGzoHsz","RaYu8uGTiuiIjLISQppPVYWw");</script><script type=text/javascript>function showTime(Counter){var query=new AV.Query(Counter);var entries=[];var $visitors=$(".leancloud_visitors");$visitors.each(function(){entries.push($(this).attr("id").trim());});query.containedIn('url',entries);query.find().done(function(results){var COUNT_CONTAINER_REF='.leancloud-visitors-count';var OLD_COUNT_CONTAINER_REF='.old-visitors-count';for(var i=0;i<results.length;i++){var item=results[i];var url=item.get('url');var time=item.get('time');var element=document.getElementById(url);$(element).find(COUNT_CONTAINER_REF).text(time);}
for(var i=0;i<entries.length;i++){var url=entries[i];var element=document.getElementById(url);var countSpan=$(element).find(COUNT_CONTAINER_REF);if(countSpan.text()==''){var oldCountSpan=$(element).find(OLD_COUNT_CONTAINER_REF).text();if(oldCountSpan!=''){countSpan.text(0+parseInt(oldCountSpan));}else{countSpan.text(0);}}}}).fail(function(object,error){console.log("Error: "+error.code+" "+error.message);});}
function addCount(Counter){var $visitors=$(".leancloud_visitors");var url=$visitors.attr('id').trim();var title=$visitors.attr('data-flag-title').trim();var query=new AV.Query(Counter);query.equalTo("url",url);query.find({success:function(results){if(results.length>0){var counter=results[0];counter.fetchWhenSave(true);counter.increment("time");counter.save(null,{success:function(counter){var $element=$(document.getElementById(url));$element.find('.leancloud-visitors-count').text(counter.get('time'));},error:function(counter,error){console.log('Failed to save Visitor num, with error message: '+error.message);}});}else{var newcounter=new Counter();var acl=new AV.ACL();acl.setPublicReadAccess(true);acl.setPublicWriteAccess(true);newcounter.setACL(acl);newcounter.set("title",title);newcounter.set("url",url);var OLD_COUNT_CONTAINER_REF='.old-visitors-count';var $element=$(document.getElementById(url));var oldCountSpan=$element.find(OLD_COUNT_CONTAINER_REF).text();if(oldCountSpan!=''){newcounter.set("time",parseInt(oldCountSpan)+1);}else{newcounter.set("time",1);}
newcounter.save(null,{success:function(newcounter){var $element=$(document.getElementById(url));$element.find('.leancloud-visitors-count').text(newcounter.get('time'));},error:function(newcounter,error){console.log('Failed to create');}});}},error:function(error){console.log('Error:'+error.code+" "+error.message);}});}
$(function(){var Counter=AV.Object.extend("Counter");if($('.leancloud_visitors').length==1){addCount(Counter);}else{showTime(Counter);}});</script></span></div></div></div></div></header><article><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2
col-md-10 col-md-offset-1
post-container"><header><h2>TOC</h2></header><nav id=TableOfContents><ol><li><a href=#背景>背景</a></li><li><a href=#准备工作>准备工作</a><ol><li><a href=#use-tk8586-or-above-will-not-compile>use tk<=8.5,8.6 or above will not compile</a></li><li><a href=#modify-the-corresponding-header-file-in-seqssimc-and-pipepsimc-assmue-tk85-header-file-is-located-in-usrlocaltk85>Modify the corresponding header file in seq/ssim.c and pipe/psim.c (assmue tk8.5 header file is located in /usr/local/tk8.5)</a></li><li><a href=#modify-makefile-in-sim>modify Makefile in sim</a></li><li><a href=#comment-matherr-in-seqssimc-and-pipepsimc>comment matherr in seq/ssim.c and pipe/psim.c</a></li></ol></li><li><a href=#part-a>PART A</a><ol><li><a href=#iteratively-sum-linked-list-elements>Iteratively sum linked list elements</a></li><li><a href=#recursively-sum-linked-list-elements>Recursively sum linked list elements</a></li><li><a href=#copy-a-source-block-to-a-destination-block>Copy a source block to a destination block</a></li></ol></li><li><a href=#part-b>PART B</a><ol><li><a href=#要求>要求</a></li><li><a href=#实现>实现</a></li><li><a href=#测试>测试</a></li></ol></li><li><a href=#part-c>PART C</a></li></ol></nav><h2 id=背景>背景</h2><p>CSAPP:3e第四章配套的实验。 第四章是讲处理器架构的，章节的重点是实现一个六阶段流水线。</p><p>lab的内容也是，需要实现一个Y86-64的流水线，并进行性能调优。</p><h2 id=准备工作>准备工作</h2><p>材料里面sim.tar解压之后，有可能是没办法编译通过的。
原因是tk（a windowing toolkit ）在8.5版本的时候废弃了某个接口，与8.6版本不兼容。</p><p>因此需要安装tk 8.5或者更低的版本。 在archlinux/manjaro下可以通过aur安装tk85.</p><h3 id=use-tk8586-or-above-will-not-compile>use tk&lt;=8.5,8.6 or above will not compile</h3><h3 id=modify-the-corresponding-header-file-in-seqssimc-and-pipepsimc-assmue-tk85-header-file-is-located-in-usrlocaltk85>Modify the corresponding header file in seq/ssim.c and pipe/psim.c (assmue tk8.5 header file is located in /usr/local/tk8.5)</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++>
<span style=color:#75715e>#</span><span style=color:#75715e>ifdef HAS_GUI</span><span style=color:#75715e>
</span><span style=color:#75715e></span><span style=color:#75715e>#</span><span style=color:#75715e>include</span> <span style=color:#75715e>&lt;tk8.5/tk.h&gt;  // #include &lt;tk/tk.h&gt;</span><span style=color:#75715e>
</span><span style=color:#75715e></span><span style=color:#75715e>#</span><span style=color:#75715e>endif </span><span style=color:#75715e>/* HAS_GUI */</span><span style=color:#75715e>
</span><span style=color:#75715e></span>


</code></pre></div><h3 id=modify-makefile-in-sim>modify Makefile in sim</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mak data-lang=mak>


<span style=color:#75715e># Comment this out if you don&#39;t have Tcl/Tk on your system
</span><span style=color:#75715e></span>
GUIMODE<span style=color:#f92672>=</span>-DHAS_GUI 

<span style=color:#75715e># Modify the following line so that gcc can find the libtcl.so and
</span><span style=color:#75715e></span><span style=color:#75715e># libtk.so libraries on your system. You may need to use the -L option
</span><span style=color:#75715e></span><span style=color:#75715e># to tell gcc which directory to look in. Comment this out if you
</span><span style=color:#75715e></span><span style=color:#75715e># don&#39;t have Tcl/Tk.
</span><span style=color:#75715e></span>
TKLIBS<span style=color:#f92672>=</span>-L/usr/lib/tcl8.5/ -ltk -ltcl

<span style=color:#75715e># Modify the following line so that gcc can find the tcl.h and tk.h
</span><span style=color:#75715e></span><span style=color:#75715e># header files on your system. Comment this out if you don&#39;t have
</span><span style=color:#75715e></span><span style=color:#75715e># Tcl/Tk.
</span><span style=color:#75715e></span>
TKINC<span style=color:#f92672>=</span>-isystem /usr/include/tcl8.5/



</code></pre></div><h3 id=comment-matherr-in-seqssimc-and-pipepsimc>comment matherr in seq/ssim.c and pipe/psim.c</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++>
<span style=color:#75715e>/* Hack for SunOS */</span>
<span style=color:#75715e>// extern int matherr();
</span><span style=color:#75715e></span><span style=color:#75715e>// int *tclDummyMathPtr = (int *) matherr;
</span><span style=color:#75715e></span>


</code></pre></div><h2 id=part-a>PART A</h2><h3 id=iteratively-sum-linked-list-elements>Iteratively sum linked list elements</h3><p>要求写一段y86-64的汇编代码，实现对一个链表元素求和，也就是如下c语言的相同功能代码。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c>
<span style=color:#75715e>/* sum_list - Sum the elements of a linked list */</span>
<span style=color:#66d9ef>long</span> <span style=color:#a6e22e>sum_list</span>(list_ptr ls)
{
    <span style=color:#66d9ef>long</span> val <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
    <span style=color:#66d9ef>while</span> (ls) {
	val <span style=color:#f92672>+</span><span style=color:#f92672>=</span> ls<span style=color:#f92672>-</span><span style=color:#f92672>&gt;</span>val;
	ls <span style=color:#f92672>=</span> ls<span style=color:#f92672>-</span><span style=color:#f92672>&gt;</span>next;
    }
    <span style=color:#66d9ef>return</span> val;
}


</code></pre></div><p>我们可以先瞅瞅这段c代码被汇编成x86-64的汇编代码是什么样。记得编译选项要 gcc -S -Og，不然默认的优化选项可能不是很容易明白。</p><p>得到</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-GAS data-lang=GAS>
sum_list:
.LFB0:
	<span style=color:#a6e22e>.cfi_startproc</span>
	<span style=color:#a6e22e>movl</span>	<span style=color:#66d9ef>$0</span>, %eax
.L2:
	<span style=color:#a6e22e>testq</span>	%rdi, %rdi
	<span style=color:#a6e22e>je</span>	<span style=color:#66d9ef>.L4</span>
	<span style=color:#a6e22e>addq</span>	(%rdi), %rax
	<span style=color:#a6e22e>movq</span>	<span style=color:#ae81ff>8</span>(%rdi), %rdi
	<span style=color:#a6e22e>jmp</span>	<span style=color:#66d9ef>.L2</span>
.L4:
	<span style=color:#a6e22e>ret</span>


</code></pre></div><p>同时，我们可以参考CSAPP:3e Figure 4.7 Y86-64的代码示例</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-GAS data-lang=GAS><span style=color:#75715e># Execution begins at address 0
</span><span style=color:#75715e></span><span style=color:#a6e22e>.pos</span> <span style=color:#ae81ff>0</span>
<span style=color:#a6e22e>irmovq</span> <span style=color:#66d9ef>stack</span>, %rsp
<span style=color:#75715e># Set up stack pointer
</span><span style=color:#75715e></span><span style=color:#a6e22e>call</span> <span style=color:#66d9ef>main</span>
<span style=color:#75715e># Execute main program
</span><span style=color:#75715e></span><span style=color:#a6e22e>halt</span>
<span style=color:#75715e># Terminate program
</span><span style=color:#75715e></span>
<span style=color:#75715e># Array of 4 elements
</span><span style=color:#75715e></span><span style=color:#a6e22e>.align</span> <span style=color:#ae81ff>8</span>
array:
<span style=color:#a6e22e>.quad</span> <span style=color:#ae81ff>0x000d000d000d</span>
<span style=color:#a6e22e>.quad</span> <span style=color:#ae81ff>0x00c000c000c0</span>
<span style=color:#a6e22e>.quad</span> <span style=color:#ae81ff>0x0b000b000b00</span>
<span style=color:#a6e22e>.quad</span> <span style=color:#ae81ff>0xa000a000a000</span>

main:
<span style=color:#a6e22e>irmovq</span> <span style=color:#66d9ef>array</span>,%rdi
<span style=color:#a6e22e>irmovq</span> <span style=color:#66d9ef>$4</span>,%rsi
<span style=color:#a6e22e>call</span> <span style=color:#66d9ef>sum</span>
<span style=color:#a6e22e>ret</span>
<span style=color:#75715e># sum(array, 4)
</span><span style=color:#75715e></span>
<span style=color:#75715e># long sum(long *start, long count)
</span><span style=color:#75715e></span><span style=color:#75715e># start in %rdi, count in %rsi
</span><span style=color:#75715e></span>sum:
<span style=color:#a6e22e>irmovq</span> <span style=color:#66d9ef>$8</span>,%r8
<span style=color:#75715e># Constant 8
</span><span style=color:#75715e></span><span style=color:#a6e22e>irmovq</span> <span style=color:#66d9ef>$1</span>,%r9
<span style=color:#75715e># Constant 1
</span><span style=color:#75715e></span><span style=color:#a6e22e>xorq</span> %rax,%rax
<span style=color:#75715e># sum = 0
</span><span style=color:#75715e></span><span style=color:#a6e22e>andq</span> %rsi,%rsi
<span style=color:#75715e># Set CC
</span><span style=color:#75715e></span><span style=color:#a6e22e>jmp</span>
<span style=color:#a6e22e>test</span>
<span style=color:#75715e># Goto test
</span><span style=color:#75715e></span>loop:
<span style=color:#a6e22e>mrmovq</span> (%rdi),%r10
<span style=color:#75715e># Get *start
</span><span style=color:#75715e></span><span style=color:#a6e22e>addq</span> %r10,%rax
<span style=color:#75715e># Add to sum
</span><span style=color:#75715e></span><span style=color:#a6e22e>addq</span> %r8,%rdi
<span style=color:#75715e># start++
</span><span style=color:#75715e></span><span style=color:#a6e22e>subq</span> %r9,%rsi
<span style=color:#75715e># count--. Set CC
</span><span style=color:#75715e></span>test:
<span style=color:#a6e22e>jne</span>
<span style=color:#a6e22e>loop</span>
<span style=color:#75715e># Stop when 0
</span><span style=color:#75715e></span><span style=color:#a6e22e>ret</span>
<span style=color:#75715e># Return
</span><span style=color:#75715e></span><span style=color:#75715e># Stack starts here and grows to lower addresses
</span><span style=color:#75715e></span><span style=color:#a6e22e>.pos</span> <span style=color:#ae81ff>0x200</span>
stack:

</code></pre></div><p>比较容易得到，我们需要的sum_list函数的Y86-64代码是:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-GAS data-lang=GAS>
    <span style=color:#a6e22e>.pos</span> <span style=color:#ae81ff>0</span>
    <span style=color:#a6e22e>irmovq</span> <span style=color:#66d9ef>stack</span>, %rsp  <span style=color:#75715e># Set up stack pointer
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>call</span> <span style=color:#66d9ef>main</span> <span style=color:#75715e># Execute main function
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>halt</span>

<span style=color:#75715e># Sample linked list
</span><span style=color:#75715e></span>    <span style=color:#a6e22e>.align</span> <span style=color:#ae81ff>8</span>
ele1:
    <span style=color:#a6e22e>.quad</span> <span style=color:#ae81ff>0x00a</span>
    <span style=color:#a6e22e>.quad</span> <span style=color:#66d9ef>ele2</span>
ele2:
    <span style=color:#a6e22e>.quad</span> <span style=color:#ae81ff>0x0b0</span>
    <span style=color:#a6e22e>.quad</span> <span style=color:#66d9ef>ele3</span>
ele3:
    <span style=color:#a6e22e>.quad</span> <span style=color:#ae81ff>0xc00</span>
    <span style=color:#a6e22e>.quad</span> <span style=color:#ae81ff>0</span>


main:
    <span style=color:#a6e22e>irmovq</span> <span style=color:#66d9ef>ele1</span>,%rdi
    <span style=color:#a6e22e>call</span> <span style=color:#66d9ef>sum_list</span>
    <span style=color:#a6e22e>ret</span>

sum_list:
    <span style=color:#a6e22e>irmovq</span> <span style=color:#66d9ef>$0</span>, %rax 
<span style=color:#66d9ef>loop</span>:
    <span style=color:#a6e22e>andq</span>  %rdi, %rdi
    <span style=color:#a6e22e>je</span> <span style=color:#66d9ef>finish</span>
    <span style=color:#a6e22e>mrmovq</span> (%rdi),%r8
    <span style=color:#a6e22e>addq</span> %r8, %rax
    <span style=color:#a6e22e>mrmovq</span> <span style=color:#ae81ff>8</span>(%rdi), %rdi
    <span style=color:#a6e22e>jmp</span> <span style=color:#66d9ef>loop</span>
finish:
    <span style=color:#a6e22e>ret</span>

<span style=color:#a6e22e>.pos</span> <span style=color:#ae81ff>0x200</span>
stack:

</code></pre></div><p>这里有几点要注意:</p><ul><li>Y86-64的代码最后必须有空行</li><li>Y86-64的cpu中，ALU的输入不能是立即数，因此如果操作数有立即数，需要先将立即数mov到寄存器中。</li><li>与上一条类似，Y86-64的ALU的输入不能是内存中的地址，因此如果操作数有内存中的地址，需要先将改地址的内容mov到寄存器中。</li><li>Y86-64的mov根据操作数的不同类别分了不同的指令，但是没有根据操作数的size来区分不同指令。</li><li>Y86-64在ALU做完操作之后会自动设置相应的condition code(CC)</li></ul><p>那么如何验证正确性呢？</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>
$  ./yas sum.ys
$  ./yis sum.yo

</code></pre></div><p>得到结果:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-GAS data-lang=GAS>
<span style=color:#a6e22e>Stopped</span> <span style=color:#66d9ef>in</span> <span style=color:#ae81ff>28</span> <span style=color:#66d9ef>steps</span> <span style=color:#66d9ef>at</span> <span style=color:#66d9ef>PC</span> <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#ae81ff>0x13</span>.  <span style=color:#66d9ef>Status</span> <span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#66d9ef>HLT</span><span style=color:#960050;background-color:#1e0010>&#39;</span>, <span style=color:#66d9ef>CC</span> <span style=color:#66d9ef>Z</span><span style=color:#960050;background-color:#1e0010>=</span><span style=color:#ae81ff>1</span> <span style=color:#66d9ef>S</span><span style=color:#960050;background-color:#1e0010>=</span><span style=color:#ae81ff>0</span> <span style=color:#66d9ef>O</span><span style=color:#960050;background-color:#1e0010>=</span><span style=color:#ae81ff>0</span>
<span style=color:#a6e22e>Changes</span> <span style=color:#66d9ef>to</span> <span style=color:#66d9ef>registers</span>:
<span style=color:#960050;background-color:#1e0010>%</span>rax:   <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x0000000000000000</span>      <span style=color:#ae81ff>0x0000000000000cba</span>
<span style=color:#960050;background-color:#1e0010>%</span>rsp:   <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x0000000000000000</span>      <span style=color:#ae81ff>0x0000000000000200</span>
<span style=color:#960050;background-color:#1e0010>%</span>r8:    <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x0000000000000000</span>      <span style=color:#ae81ff>0x0000000000000c00</span>

<span style=color:#a6e22e>Changes</span> <span style=color:#66d9ef>to</span> <span style=color:#66d9ef>memory</span>:
<span style=color:#960050;background-color:#1e0010>0</span>x01f0: <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x0000000000000000</span>      <span style=color:#ae81ff>0x000000000000005b</span>
<span style=color:#960050;background-color:#1e0010>0</span>x01f8: <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x0000000000000000</span>      <span style=color:#ae81ff>0x0000000000000013</span>

</code></pre></div><p>%rax中存放的结果为0xcba,结果正确。</p><h3 id=recursively-sum-linked-list-elements>Recursively sum linked list elements</h3><p>思路和上面类似，不多说了。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-GAS data-lang=GAS>
    <span style=color:#a6e22e>.pos</span> <span style=color:#ae81ff>0</span>
    <span style=color:#a6e22e>irmovq</span> <span style=color:#66d9ef>stack</span>, %rsp  <span style=color:#75715e># Set up stack pointer
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>call</span> <span style=color:#66d9ef>main</span> <span style=color:#75715e># Execute main function
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>halt</span>

<span style=color:#75715e># Sample linked list
</span><span style=color:#75715e></span>    <span style=color:#a6e22e>.align</span> <span style=color:#ae81ff>8</span>
ele1:
    <span style=color:#a6e22e>.quad</span> <span style=color:#ae81ff>0x00a</span>
    <span style=color:#a6e22e>.quad</span> <span style=color:#66d9ef>ele2</span>
ele2:
    <span style=color:#a6e22e>.quad</span> <span style=color:#ae81ff>0x0b0</span>
    <span style=color:#a6e22e>.quad</span> <span style=color:#66d9ef>ele3</span>
ele3:
    <span style=color:#a6e22e>.quad</span> <span style=color:#ae81ff>0xc00</span>
    <span style=color:#a6e22e>.quad</span> <span style=color:#ae81ff>0</span>


main:
    <span style=color:#a6e22e>irmovq</span> <span style=color:#66d9ef>ele1</span>,%rdi
    <span style=color:#a6e22e>call</span> <span style=color:#66d9ef>rsum_list</span>
    <span style=color:#a6e22e>ret</span>

rsum_list:
    <span style=color:#a6e22e>andq</span>  %rdi, %rdi
    <span style=color:#a6e22e>je</span> <span style=color:#66d9ef>finish</span>
    <span style=color:#a6e22e>pushq</span> %rbx
    <span style=color:#a6e22e>mrmovq</span> (%rdi),%rbx     <span style=color:#75715e># val
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>mrmovq</span> <span style=color:#ae81ff>8</span>(%rdi), %rdi   <span style=color:#75715e># ls-&gt;next
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>call</span> <span style=color:#66d9ef>rsum_list</span>
    <span style=color:#a6e22e>addq</span> %rbx, %rax
    <span style=color:#a6e22e>popq</span> %rbx
    <span style=color:#a6e22e>ret</span> 

<span style=color:#66d9ef>finish</span>:
    <span style=color:#a6e22e>irmovq</span> <span style=color:#66d9ef>$0</span>, %rax 
    <span style=color:#66d9ef>ret</span>

<span style=color:#a6e22e>.pos</span> <span style=color:#ae81ff>0x200</span>
stack:




</code></pre></div><h3 id=copy-a-source-block-to-a-destination-block>Copy a source block to a destination block</h3><p>注意有三个参数，按照x86-64调用惯例，三个参数依次放入寄存器:</p><p>%rdi,%rsi,%rdx</p><p><img src=https://i.loli.net/2020/02/28/PNsgDbqRGU793Hm.png alt=x86-64调用惯例.png></p><p>除此以外没什么需要注意的。。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-GAS data-lang=GAS>
    <span style=color:#a6e22e>.pos</span> <span style=color:#ae81ff>0</span>
    <span style=color:#a6e22e>irmovq</span> <span style=color:#66d9ef>stack</span>, %rsp  <span style=color:#75715e># Set up stack pointer
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>call</span> <span style=color:#66d9ef>main</span> <span style=color:#75715e># Execute main function
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>halt</span>

<span style=color:#a6e22e>.align</span> <span style=color:#ae81ff>8</span>
<span style=color:#75715e># Source block
</span><span style=color:#75715e></span>src:
    <span style=color:#a6e22e>.quad</span> <span style=color:#ae81ff>0x00a</span>
    <span style=color:#a6e22e>.quad</span> <span style=color:#ae81ff>0x0b0</span>
    <span style=color:#a6e22e>.quad</span> <span style=color:#ae81ff>0xc00</span>
<span style=color:#75715e># Destination block
</span><span style=color:#75715e></span>dest:
    <span style=color:#a6e22e>.quad</span> <span style=color:#ae81ff>0x111</span>
    <span style=color:#a6e22e>.quad</span> <span style=color:#ae81ff>0x222</span>
    <span style=color:#a6e22e>.quad</span> <span style=color:#ae81ff>0x333</span>


main:
    <span style=color:#a6e22e>irmovq</span> <span style=color:#66d9ef>src</span>,%rdi
    <span style=color:#a6e22e>irmovq</span> <span style=color:#66d9ef>dest</span>,%rsi
    <span style=color:#a6e22e>irmovq</span> <span style=color:#66d9ef>$3</span>,%rdx

    <span style=color:#a6e22e>call</span> <span style=color:#66d9ef>copy_block</span>
    <span style=color:#a6e22e>ret</span>

copy_block:
    <span style=color:#a6e22e>irmovq</span> <span style=color:#66d9ef>$8</span>,%r8
    <span style=color:#a6e22e>irmovq</span> <span style=color:#66d9ef>$1</span>,%r9
    <span style=color:#a6e22e>irmovq</span> <span style=color:#66d9ef>$0</span>, %rcx 
<span style=color:#66d9ef>loop</span>:
    <span style=color:#a6e22e>andq</span>  %rdx, %rdx
    <span style=color:#a6e22e>jle</span> <span style=color:#66d9ef>finish</span>
    <span style=color:#a6e22e>mrmovq</span> (%rdi),%rax
    <span style=color:#a6e22e>rmmovq</span> %rax,(%rsi)
    <span style=color:#a6e22e>xorq</span> %rax,%rcx
    <span style=color:#a6e22e>subq</span> %r9, %rdx
    <span style=color:#a6e22e>addq</span> %r8,%rdi
    <span style=color:#a6e22e>addq</span> %r8,%rsi
    <span style=color:#a6e22e>jmp</span> <span style=color:#66d9ef>loop</span>
finish:
    <span style=color:#a6e22e>rrmovq</span>  %rcx,%rax
    <span style=color:#a6e22e>ret</span>

<span style=color:#a6e22e>.pos</span> <span style=color:#ae81ff>0x200</span>
stack:




</code></pre></div><h2 id=part-b>PART B</h2><h3 id=要求>要求</h3><p>part B要求扩展 SEQ processor 来实现iadd指令，也就是支持立即数的加法指令。具体的要求可以参考CSAPP:3e的Homework problems 4.51 and 4.52</p><blockquote><p>4.51 ◆
Practice Problem 4.3 introduced the iaddq instruction to add immediate data to a
register. Describe the computations performed to implement this instruction. Use
the computations for irmovq and OPq (Figure 4.18) as a guide.</p></blockquote><blockquote><p>4.52 ◆◆
The file seq-full.hcl contains the HCL description for SEQ, along with the
declaration of a constant IIADDQ having hexadecimal value C, the instruction code
for iaddq. Modify the HCL descriptions of the control logic blocks to implement
the iaddq instruction, as described in Practice Problem 4.3 and Problem 4.51. See
the lab material for directions on how to generate a simulator for your solution
and how to test it.</p></blockquote><p>Figure 4.18
<img src=https://i.loli.net/2020/02/29/ae4cUnPl9yWNLS6.png alt=Y86-64指令描述.png></p><p>Practice Problem 4.3
<img src=https://i.loli.net/2020/02/29/jIgOynPMzfAxWoK.png alt=practice_4.3.png></p><h3 id=实现>实现</h3><p>先写出iaddq的stage描述:</p><p>iaddq V,rB</p><ul><li>Fetch<ul><li>icode:ifun &lt;&ndash; M1[PC]</li><li>rA:rB &lt;&ndash; M1[PC+1]</li><li>valC &lt;&ndash; M8[PC+2]</li><li>valP &lt;&ndash; PC+10</li></ul></li><li>Decode<ul><li>valB &lt;&ndash; R[rB]</li></ul></li><li>Execute<ul><li>valE &lt;&ndash; valB + valC</li></ul></li><li>Memory</li><li>Write back<ul><li>R[rB] &lt;&ndash; valE</li></ul></li><li>PC update<ul><li>PC &lt;&ndash; valP</li></ul></li></ul><p>然后修改seq-full.hcl。 参考IOPQ 和IIRMOVQ 来实现还是比较容易的。
下面把修改过的位置放了出来:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=color:#75715e>
</span><span style=color:#75715e>################ Fetch Stage     ###################################
</span><span style=color:#75715e></span>
bool instr_valid <span style=color:#f92672>=</span> <span style=color:#66d9ef>icode</span> <span style=color:#66d9ef>in</span> 
	{ <span style=color:#66d9ef>INOP</span>, <span style=color:#66d9ef>IHALT</span>, <span style=color:#66d9ef>IRRMOVQ</span>, <span style=color:#66d9ef>IIRMOVQ</span>, <span style=color:#66d9ef>IRMMOVQ</span>, <span style=color:#66d9ef>IMRMOVQ</span>,
	       <span style=color:#66d9ef>IOPQ</span>, <span style=color:#66d9ef>IIADDQ</span>, <span style=color:#66d9ef>IJXX</span>, <span style=color:#66d9ef>ICALL</span>, <span style=color:#66d9ef>IRET</span>, <span style=color:#66d9ef>IPUSHQ</span>, <span style=color:#66d9ef>IPOPQ</span> }<span style=color:#960050;background-color:#1e0010>;</span>  
             

<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#960050;background-color:#1e0010>/</span> <span style=color:#66d9ef>Does</span> <span style=color:#66d9ef>fetched</span> <span style=color:#66d9ef>instruction</span> <span style=color:#66d9ef>require</span> <span style=color:#66d9ef>a</span> <span style=color:#66d9ef>regid</span> <span style=color:#66d9ef>byte</span><span style=color:#960050;background-color:#1e0010>?</span>   
bool need_regids <span style=color:#f92672>=</span>
	<span style=color:#66d9ef>icode</span> <span style=color:#66d9ef>in</span> { <span style=color:#66d9ef>IRRMOVQ</span>, <span style=color:#66d9ef>IOPQ</span>, <span style=color:#66d9ef>IIADDQ</span>, <span style=color:#66d9ef>IPUSHQ</span>, <span style=color:#66d9ef>IPOPQ</span>, 
		     <span style=color:#66d9ef>IIRMOVQ</span>, <span style=color:#66d9ef>IRMMOVQ</span>, <span style=color:#66d9ef>IMRMOVQ</span> }<span style=color:#960050;background-color:#1e0010>;</span>


<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#960050;background-color:#1e0010>/</span> <span style=color:#66d9ef>Does</span> <span style=color:#66d9ef>fetched</span> <span style=color:#66d9ef>instruction</span> <span style=color:#66d9ef>require</span> <span style=color:#66d9ef>a</span> <span style=color:#66d9ef>constant</span> <span style=color:#66d9ef>word</span><span style=color:#960050;background-color:#1e0010>?</span>
bool need_valC <span style=color:#f92672>=</span>
	<span style=color:#66d9ef>icode</span> <span style=color:#66d9ef>in</span> { <span style=color:#66d9ef>IIRMOVQ</span>, <span style=color:#66d9ef>IIADDQ</span>,<span style=color:#66d9ef>IRMMOVQ</span>, <span style=color:#66d9ef>IMRMOVQ</span>, <span style=color:#66d9ef>IJXX</span>, <span style=color:#66d9ef>ICALL</span> }<span style=color:#960050;background-color:#1e0010>;</span>


<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#75715e> ################ Decode Stage    ###################################
</span><span style=color:#75715e></span>

<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#960050;background-color:#1e0010>/</span> <span style=color:#66d9ef>What</span> <span style=color:#66d9ef>register</span> <span style=color:#66d9ef>should</span> <span style=color:#66d9ef>be</span> <span style=color:#66d9ef>used</span> <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>the</span> <span style=color:#66d9ef>B</span> <span style=color:#66d9ef>source</span><span style=color:#960050;background-color:#1e0010>?</span>
word srcB <span style=color:#f92672>=</span> [
	<span style=color:#66d9ef>icode</span> <span style=color:#66d9ef>in</span> { <span style=color:#66d9ef>IOPQ</span>, <span style=color:#66d9ef>IIADDQ</span>, <span style=color:#66d9ef>IRMMOVQ</span>, <span style=color:#66d9ef>IMRMOVQ</span>  } <span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#66d9ef>rB</span><span style=color:#960050;background-color:#1e0010>;</span>
	<span style=color:#66d9ef>icode</span> <span style=color:#66d9ef>in</span> { <span style=color:#66d9ef>IPUSHQ</span>, <span style=color:#66d9ef>IPOPQ</span>, <span style=color:#66d9ef>ICALL</span>, <span style=color:#66d9ef>IRET</span> } <span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#66d9ef>RRSP</span><span style=color:#960050;background-color:#1e0010>;</span>
	<span style=color:#ae81ff>1</span> <span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#66d9ef>RNONE</span><span style=color:#960050;background-color:#1e0010>;</span><span style=color:#75715e>  # Don&#39;t need register
</span><span style=color:#75715e></span>]<span style=color:#960050;background-color:#1e0010>;</span>


<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#960050;background-color:#1e0010>/</span> <span style=color:#66d9ef>What</span> <span style=color:#66d9ef>register</span> <span style=color:#66d9ef>should</span> <span style=color:#66d9ef>be</span> <span style=color:#66d9ef>used</span> <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>the</span> <span style=color:#66d9ef>E</span> <span style=color:#66d9ef>destination</span><span style=color:#960050;background-color:#1e0010>?</span>
word dstE <span style=color:#f92672>=</span> [
	<span style=color:#66d9ef>icode</span> <span style=color:#66d9ef>in</span> { <span style=color:#66d9ef>IRRMOVQ</span> } <span style=color:#960050;background-color:#1e0010>&amp;</span><span style=color:#960050;background-color:#1e0010>&amp;</span> <span style=color:#66d9ef>Cnd</span> <span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#66d9ef>rB</span><span style=color:#960050;background-color:#1e0010>;</span>
	<span style=color:#66d9ef>icode</span> <span style=color:#66d9ef>in</span> { <span style=color:#66d9ef>IIRMOVQ</span>, <span style=color:#66d9ef>IOPQ</span>,<span style=color:#66d9ef>IIADDQ</span>} <span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#66d9ef>rB</span><span style=color:#960050;background-color:#1e0010>;</span>
	<span style=color:#66d9ef>icode</span> <span style=color:#66d9ef>in</span> { <span style=color:#66d9ef>IPUSHQ</span>, <span style=color:#66d9ef>IPOPQ</span>, <span style=color:#66d9ef>ICALL</span>, <span style=color:#66d9ef>IRET</span> } <span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#66d9ef>RRSP</span><span style=color:#960050;background-color:#1e0010>;</span>
	<span style=color:#ae81ff>1</span> <span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#66d9ef>RNONE</span><span style=color:#960050;background-color:#1e0010>;</span><span style=color:#75715e>  # Don&#39;t write any register
</span><span style=color:#75715e></span>]<span style=color:#960050;background-color:#1e0010>;</span>

<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#75715e> ################ Execute Stage   ###################################
</span><span style=color:#75715e></span>


<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#960050;background-color:#1e0010>/</span> <span style=color:#66d9ef>Select</span> <span style=color:#66d9ef>input</span> <span style=color:#66d9ef>A</span> <span style=color:#66d9ef>to</span> <span style=color:#66d9ef>ALU</span>
word aluA <span style=color:#f92672>=</span> [
	<span style=color:#66d9ef>icode</span> <span style=color:#66d9ef>in</span> { <span style=color:#66d9ef>IRRMOVQ</span>, <span style=color:#66d9ef>IOPQ</span> } <span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#66d9ef>valA</span><span style=color:#960050;background-color:#1e0010>;</span>
	<span style=color:#66d9ef>icode</span> <span style=color:#66d9ef>in</span> { <span style=color:#66d9ef>IIRMOVQ</span>, <span style=color:#66d9ef>IRMMOVQ</span>, <span style=color:#66d9ef>IMRMOVQ</span>, <span style=color:#66d9ef>IIADDQ</span> } <span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#66d9ef>valC</span><span style=color:#960050;background-color:#1e0010>;</span>
	<span style=color:#66d9ef>icode</span> <span style=color:#66d9ef>in</span> { <span style=color:#66d9ef>ICALL</span>, <span style=color:#66d9ef>IPUSHQ</span> } <span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#960050;background-color:#1e0010>-</span><span style=color:#ae81ff>8</span><span style=color:#960050;background-color:#1e0010>;</span>
	<span style=color:#66d9ef>icode</span> <span style=color:#66d9ef>in</span> { <span style=color:#66d9ef>IRET</span>, <span style=color:#66d9ef>IPOPQ</span> } <span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#ae81ff>8</span><span style=color:#960050;background-color:#1e0010>;</span><span style=color:#75715e>
</span><span style=color:#75715e>	# Other instructions don&#39;t need ALU
</span><span style=color:#75715e></span>]<span style=color:#960050;background-color:#1e0010>;</span>


<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#960050;background-color:#1e0010>/</span> <span style=color:#66d9ef>Select</span> <span style=color:#66d9ef>input</span> <span style=color:#66d9ef>B</span> <span style=color:#66d9ef>to</span> <span style=color:#66d9ef>ALU</span>
word aluB <span style=color:#f92672>=</span> [
	<span style=color:#66d9ef>icode</span> <span style=color:#66d9ef>in</span> { <span style=color:#66d9ef>IRMMOVQ</span>, <span style=color:#66d9ef>IMRMOVQ</span>, <span style=color:#66d9ef>IOPQ</span>, <span style=color:#66d9ef>IIADDQ</span>, <span style=color:#66d9ef>ICALL</span>, 
		      <span style=color:#66d9ef>IPUSHQ</span>, <span style=color:#66d9ef>IRET</span>, <span style=color:#66d9ef>IPOPQ</span> } <span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#66d9ef>valB</span><span style=color:#960050;background-color:#1e0010>;</span>
	<span style=color:#66d9ef>icode</span> <span style=color:#66d9ef>in</span> { <span style=color:#66d9ef>IRRMOVQ</span>, <span style=color:#66d9ef>IIRMOVQ</span> } <span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#ae81ff>0</span><span style=color:#960050;background-color:#1e0010>;</span><span style=color:#75715e>
</span><span style=color:#75715e>	# Other instructions don&#39;t need ALU
</span><span style=color:#75715e></span>]<span style=color:#960050;background-color:#1e0010>;</span>


<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#960050;background-color:#1e0010>/</span> <span style=color:#66d9ef>Set</span> <span style=color:#66d9ef>the</span> <span style=color:#66d9ef>ALU</span> <span style=color:#66d9ef>function</span>
word alufun <span style=color:#f92672>=</span> [
	icode <span style=color:#f92672>=</span><span style=color:#f92672>=</span> <span style=color:#66d9ef>IOPQ</span> <span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#66d9ef>ifun</span><span style=color:#960050;background-color:#1e0010>;</span>
	<span style=color:#ae81ff>1</span> <span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#66d9ef>ALUADD</span><span style=color:#960050;background-color:#1e0010>;</span>
]<span style=color:#960050;background-color:#1e0010>;</span>


<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#960050;background-color:#1e0010>/</span> <span style=color:#66d9ef>Should</span> <span style=color:#66d9ef>the</span> <span style=color:#66d9ef>condition</span> <span style=color:#66d9ef>codes</span> <span style=color:#66d9ef>be</span> <span style=color:#66d9ef>updated</span><span style=color:#960050;background-color:#1e0010>?</span>
bool set_cc <span style=color:#f92672>=</span> <span style=color:#66d9ef>icode</span> <span style=color:#66d9ef>in</span> { <span style=color:#66d9ef>IOPQ</span>,<span style=color:#66d9ef>IIADDQ</span> }<span style=color:#960050;background-color:#1e0010>;</span>


</code></pre></div><h3 id=测试>测试</h3><p>在benchmark上测试</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>
➜  y86-code git:<span style=color:#f92672>(</span>master<span style=color:#f92672>)</span> ✗ make testssim
../seq/ssim -t asum.yo &gt; asum.seq
../seq/ssim -t asumr.yo &gt; asumr.seq
../seq/ssim -t cjr.yo &gt; cjr.seq
../seq/ssim -t j-cc.yo &gt; j-cc.seq
../seq/ssim -t poptest.yo &gt; poptest.seq
../seq/ssim -t pushquestion.yo &gt; pushquestion.seq
../seq/ssim -t pushtest.yo &gt; pushtest.seq
../seq/ssim -t prog1.yo &gt; prog1.seq
../seq/ssim -t prog2.yo &gt; prog2.seq
../seq/ssim -t prog3.yo &gt; prog3.seq
../seq/ssim -t prog4.yo &gt; prog4.seq
../seq/ssim -t prog5.yo &gt; prog5.seq
../seq/ssim -t prog6.yo &gt; prog6.seq
../seq/ssim -t prog7.yo &gt; prog7.seq
../seq/ssim -t prog8.yo &gt; prog8.seq
../seq/ssim -t ret-hazard.yo &gt; ret-hazard.seq
grep <span style=color:#e6db74>&#34;ISA Check&#34;</span> *.seq
asumr.seq:ISA Check Succeeds
asum.seq:ISA Check Succeeds
cjr.seq:ISA Check Succeeds
j-cc.seq:ISA Check Succeeds
poptest.seq:ISA Check Succeeds
prog1.seq:ISA Check Succeeds
prog2.seq:ISA Check Succeeds
prog3.seq:ISA Check Succeeds
prog4.seq:ISA Check Succeeds
prog5.seq:ISA Check Succeeds
prog6.seq:ISA Check Succeeds
prog7.seq:ISA Check Succeeds
prog8.seq:ISA Check Succeeds
pushquestion.seq:ISA Check Succeeds
pushtest.seq:ISA Check Succeeds
ret-hazard.seq:ISA Check Succeeds
rm asum.seq asumr.seq cjr.seq j-cc.seq poptest.seq pushquestion.seq pushtest.seq prog1.seq prog2.seq prog3.seq prog4.seq prog5.seq prog6.seq prog7.seq prog8.seq ret-hazard.seq

</code></pre></div><p>执行回归测试</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>
➜  ptest git:<span style=color:#f92672>(</span>master<span style=color:#f92672>)</span> ✗ make SIM<span style=color:#f92672>=</span>../seq/ssim
./optest.pl -s ../seq/ssim 
Simulating with ../seq/ssim
  All <span style=color:#ae81ff>49</span> ISA Checks Succeed
./jtest.pl -s ../seq/ssim 
Simulating with ../seq/ssim
  All <span style=color:#ae81ff>64</span> ISA Checks Succeed
./ctest.pl -s ../seq/ssim 
Simulating with ../seq/ssim
  All <span style=color:#ae81ff>22</span> ISA Checks Succeed
./htest.pl -s ../seq/ssim 
Simulating with ../seq/ssim
  All <span style=color:#ae81ff>600</span> ISA Checks Succeed
➜  ptest git:<span style=color:#f92672>(</span>master<span style=color:#f92672>)</span> ✗ make SIM<span style=color:#f92672>=</span>../seq/ssim TFLAGS<span style=color:#f92672>=</span>-i
./optest.pl -s ../seq/ssim -i
Simulating with ../seq/ssim
  All <span style=color:#ae81ff>58</span> ISA Checks Succeed
./jtest.pl -s ../seq/ssim -i
Simulating with ../seq/ssim
  All <span style=color:#ae81ff>96</span> ISA Checks Succeed
./ctest.pl -s ../seq/ssim -i
Simulating with ../seq/ssim
  All <span style=color:#ae81ff>22</span> ISA Checks Succeed
./htest.pl -s ../seq/ssim -i
Simulating with ../seq/ssim
  All <span style=color:#ae81ff>756</span> ISA Checks Succeed


</code></pre></div><p>全部都是&rdquo; ISA Checks Succeed&rdquo;，说明结果应该OK</p><h2 id=part-c>PART C</h2><p>这个lab的前两部分给人一种很简单的错觉。。。。让人觉得，不过如此嘛</p><p>然后就死了。。。也可能是我的思路不对。。。</p><p>以为homework会比lab内容简单。。。 于是先跑去做了pipe-bt..把分支预测改成not token&mldr; 没做出来。。</p><p>又去做了pipe-nobypass,改成没有forwarding机制。。 发现要考虑的case多到爆炸。。调到怀疑人生，怀疑我是不是不适合CS.</p><p>大概卡了一周。。不得已去搜答案。。发现做课后几个pipeline相关题目的人并不多。。而且似乎比lab本身要难很多。。。</p><p>然后循环展开的优化打算读完第五章再说。。</p><p>20200425更新:</p><p>转眼都快五月了,终于把这个坑填了.</p><p>说一下我优化的思路吧.
根据提示,循环展开肯定是一个非常重要的优化. 于是先尝试实现一个2x1的循环展开看下效果.</p><p>先把对应的c的代码写了出来:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c>
<span style=color:#66d9ef>typedef</span> <span style=color:#66d9ef>int</span> word_t;
word_t <span style=color:#a6e22e>ncopy2</span>(word_t <span style=color:#f92672>*</span>src, word_t <span style=color:#f92672>*</span>dst, word_t len)
{
    word_t count <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
    word_t val;
    word_t val2;

    <span style=color:#66d9ef>while</span> (len <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>1</span>) {
        val <span style=color:#f92672>=</span> <span style=color:#f92672>*</span>src<span style=color:#f92672>+</span><span style=color:#f92672>+</span>;
        val2 <span style=color:#f92672>=</span> <span style=color:#f92672>*</span>src<span style=color:#f92672>+</span><span style=color:#f92672>+</span>;
        <span style=color:#f92672>*</span>dst<span style=color:#f92672>+</span><span style=color:#f92672>+</span> <span style=color:#f92672>=</span> val;
        <span style=color:#f92672>*</span>dst<span style=color:#f92672>+</span><span style=color:#f92672>+</span> <span style=color:#f92672>=</span> val2;
        <span style=color:#66d9ef>if</span> (val <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>)
            count<span style=color:#f92672>+</span><span style=color:#f92672>+</span>;
        <span style=color:#66d9ef>if</span> (val2 <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>)
            count<span style=color:#f92672>+</span><span style=color:#f92672>+</span>;
        len<span style=color:#f92672>-</span><span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>;
    }
    <span style=color:#66d9ef>while</span> (len<span style=color:#f92672>&gt;</span><span style=color:#ae81ff>0</span>){
        val <span style=color:#f92672>=</span> <span style=color:#f92672>*</span>src;
        <span style=color:#f92672>*</span>dst <span style=color:#f92672>=</span> val;
        <span style=color:#66d9ef>if</span> (val<span style=color:#f92672>&gt;</span><span style=color:#ae81ff>0</span>)
        count<span style=color:#f92672>+</span><span style=color:#f92672>+</span>;
        len<span style=color:#f92672>-</span><span style=color:#f92672>-</span>;
    }
    <span style=color:#66d9ef>return</span> count;
}

</code></pre></div><p>遇到的第一个问题是如何判断len>1..
如果是x86汇编可以使用cmp指令,但是Y86并没有这个指令.</p><p>考虑到cmp是不影响寄存器值的sub,参考<a href=https://stackoverflow.com/questions/15098073/how-to-convert-ia32-cmp-instruction-to-y86>How to convert IA32 &lsquo;cmp&rsquo; instruction to Y86?</a></p><p>我们可以用栈来保护被sub影响的值</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-GAS data-lang=GAS>
<span style=color:#a6e22e>pushl</span> %ecx
<span style=color:#a6e22e>subl</span>  %ebx, %ecx
<span style=color:#a6e22e>popl</span>  %ecx

</code></pre></div><p>于是得到2x1循环展开的初始版本,CPE是11.6,分数是0</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-GAS data-lang=GAS>
<span style=color:#75715e># You can modify this portion
</span><span style=color:#75715e></span>	<span style=color:#75715e># Loop header
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>xorq</span> %rax,%rax		<span style=color:#75715e># count = 0;
</span><span style=color:#75715e></span>	<span style=color:#66d9ef>irmovq</span> <span style=color:#66d9ef>$1</span>, %r10
	<span style=color:#a6e22e>pushq</span> %rdx
	<span style=color:#a6e22e>subq</span>  %r10, %rdx
	<span style=color:#a6e22e>popq</span>  %rdx		<span style=color:#75715e># len &lt;= 1?
</span><span style=color:#75715e></span>	<span style=color:#66d9ef>jle</span> <span style=color:#66d9ef>Single</span>		<span style=color:#75715e># if so, goto Done:
</span><span style=color:#75715e></span>
Loop:	
	<span style=color:#a6e22e>mrmovq</span> (%rdi), %r10	<span style=color:#75715e># read val from src...
</span><span style=color:#75715e></span>	<span style=color:#66d9ef>mrmovq</span> <span style=color:#ae81ff>8</span>(%rdi), %r11 <span style=color:#75715e># read val2 from src++
</span><span style=color:#75715e></span>	<span style=color:#66d9ef>rmmovq</span> %r10, (%rsi)	<span style=color:#75715e># ...and store it to dst
</span><span style=color:#75715e></span>	<span style=color:#66d9ef>rmmovq</span> %r11, <span style=color:#ae81ff>8</span>(%rsi) <span style=color:#75715e># .. store val2 to dst++
</span><span style=color:#75715e></span>	<span style=color:#66d9ef>andq</span> %r10, %r10		<span style=color:#75715e># val &lt;= 0?
</span><span style=color:#75715e></span>	<span style=color:#66d9ef>jle</span> <span style=color:#66d9ef>Npos</span>		<span style=color:#75715e># if so, goto Npos:
</span><span style=color:#75715e></span>	<span style=color:#66d9ef>iaddq</span> <span style=color:#66d9ef>$1</span>, %rax
	<span style=color:#75715e># irmovq $1, %r10
</span><span style=color:#75715e></span>	<span style=color:#75715e># addq %r10, %rax		# count++
</span><span style=color:#75715e></span>
Npos:
	<span style=color:#a6e22e>andq</span> %r11, %r11
	<span style=color:#a6e22e>jle</span>	<span style=color:#66d9ef>Npos2</span>
	<span style=color:#75715e># irmovq $1, %r10
</span><span style=color:#75715e></span>	<span style=color:#75715e># addq %r10, %rax
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>iaddq</span> <span style=color:#66d9ef>$1</span>, %rax

Npos2:	
    <span style=color:#a6e22e>irmovq</span> <span style=color:#66d9ef>$2</span>, %r10
	<span style=color:#a6e22e>subq</span> %r10, %rdx		<span style=color:#75715e># len-=2
</span><span style=color:#75715e></span>	<span style=color:#66d9ef>irmovq</span> <span style=color:#66d9ef>$16</span>, %r10
	<span style=color:#a6e22e>addq</span> %r10, %rdi		<span style=color:#75715e># src++
</span><span style=color:#75715e></span>	<span style=color:#66d9ef>addq</span> %r10, %rsi		<span style=color:#75715e># dst++
</span><span style=color:#75715e></span>	<span style=color:#66d9ef>irmovq</span> <span style=color:#66d9ef>$1</span>, %r10
	<span style=color:#a6e22e>pushq</span> %rdx
	<span style=color:#a6e22e>subq</span>  %r10, %rdx
	<span style=color:#a6e22e>popq</span>  %rdx		<span style=color:#75715e># len &gt; 1?
</span><span style=color:#75715e></span>
	<span style=color:#a6e22e>jg</span> <span style=color:#66d9ef>Loop</span>			<span style=color:#75715e># if so, goto Loop:
</span><span style=color:#75715e></span>
Single:
	<span style=color:#a6e22e>andq</span> %rdx, %rdx
	<span style=color:#a6e22e>jle</span> <span style=color:#66d9ef>Done</span>
	<span style=color:#a6e22e>mrmovq</span> (%rdi),%r10
	<span style=color:#a6e22e>rmmovq</span> %r10, (%rsi)
	<span style=color:#a6e22e>andq</span> %r10, %r10
	<span style=color:#a6e22e>jle</span> <span style=color:#66d9ef>Done</span> 
	<span style=color:#75715e># irmovq $1, %r10
</span><span style=color:#75715e></span>	<span style=color:#75715e># addq %r10, %rax		# count++
</span><span style=color:#75715e></span>	<span style=color:#66d9ef>iaddq</span> <span style=color:#66d9ef>$1</span>, %rax
<span style=color:#75715e>##################################################################
</span><span style=color:#75715e></span><span style=color:#75715e># Do not modify the following section of code
</span><span style=color:#75715e></span><span style=color:#75715e># Function epilogue.
</span><span style=color:#75715e></span>Done:
	<span style=color:#a6e22e>ret</span>

</code></pre></div><p>接下来,我们发现由于一些指令无法使用立即数作为参数,%r10这个寄存器在频繁地作为临时变量存储一些常数. 我们考虑使用更多的寄存器,来存储这几个常数. CPE可以从11.6提高到10.6. 这个时候,仍然是0分.</p><p>想起我们之前实现了的iaddq指令. 不妨把所有的加法和减法运算都用iaddq来替代..CPE课可以从10.6到10.41. 终于有分了.</p><p>然后观察代码..发现瓶颈可能在push和pop&mldr; 因为压栈和出栈都要访问内存.仔细思考一下,其实不是一定要和x86的cmp指令等价. 因此其实是没必要来保护对应寄存器的值的.</p><p>于是得到如下CPE可以到9.48的版本:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-GAS data-lang=GAS>
<span style=color:#75715e># You can modify this portion
</span><span style=color:#75715e></span>	<span style=color:#75715e># Loop header
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>xorq</span> %rax,%rax		<span style=color:#75715e># count = 0;
</span><span style=color:#75715e></span>	<span style=color:#66d9ef>irmovq</span> <span style=color:#66d9ef>$1</span>, %r10
	<span style=color:#a6e22e>pushq</span> %rdx
	<span style=color:#a6e22e>subq</span>  %r10, %rdx
	<span style=color:#a6e22e>popq</span>  %rdx		<span style=color:#75715e># len &lt;= 1?
</span><span style=color:#75715e></span>	<span style=color:#66d9ef>jle</span> <span style=color:#66d9ef>Single</span>		<span style=color:#75715e># if so, goto Done:
</span><span style=color:#75715e></span>
Loop:	
	<span style=color:#a6e22e>mrmovq</span> (%rdi), %r10	<span style=color:#75715e># read val from src...
</span><span style=color:#75715e></span>	<span style=color:#66d9ef>mrmovq</span> <span style=color:#ae81ff>8</span>(%rdi), %r11 <span style=color:#75715e># read val2 from src++
</span><span style=color:#75715e></span>	<span style=color:#66d9ef>rmmovq</span> %r10, (%rsi)	<span style=color:#75715e># ...and store it to dst
</span><span style=color:#75715e></span>	<span style=color:#66d9ef>rmmovq</span> %r11, <span style=color:#ae81ff>8</span>(%rsi) <span style=color:#75715e># .. store val2 to dst++
</span><span style=color:#75715e></span>	<span style=color:#66d9ef>andq</span> %r10, %r10		<span style=color:#75715e># val &lt;= 0?
</span><span style=color:#75715e></span>	<span style=color:#66d9ef>jle</span> <span style=color:#66d9ef>Npos</span>		<span style=color:#75715e># if so, goto Npos:
</span><span style=color:#75715e></span>	<span style=color:#66d9ef>iaddq</span> <span style=color:#66d9ef>$1</span>, %rax
	<span style=color:#75715e># irmovq $1, %r10
</span><span style=color:#75715e></span>	<span style=color:#75715e># addq %r10, %rax		# count++
</span><span style=color:#75715e></span>
Npos:
	<span style=color:#a6e22e>andq</span> %r11, %r11
	<span style=color:#a6e22e>jle</span>	<span style=color:#66d9ef>Npos2</span>
	<span style=color:#75715e># irmovq $1, %r10
</span><span style=color:#75715e></span>	<span style=color:#75715e># addq %r10, %rax
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>iaddq</span> <span style=color:#66d9ef>$1</span>, %rax

Npos2:	
    <span style=color:#a6e22e>irmovq</span> <span style=color:#66d9ef>$2</span>, %r10
	<span style=color:#a6e22e>subq</span> %r10, %rdx		<span style=color:#75715e># len-=2
</span><span style=color:#75715e></span>	<span style=color:#66d9ef>irmovq</span> <span style=color:#66d9ef>$16</span>, %r10
	<span style=color:#a6e22e>addq</span> %r10, %rdi		<span style=color:#75715e># src++
</span><span style=color:#75715e></span>	<span style=color:#66d9ef>addq</span> %r10, %rsi		<span style=color:#75715e># dst++
</span><span style=color:#75715e></span>	<span style=color:#66d9ef>irmovq</span> <span style=color:#66d9ef>$1</span>, %r10
	<span style=color:#a6e22e>pushq</span> %rdx
	<span style=color:#a6e22e>subq</span>  %r10, %rdx
	<span style=color:#a6e22e>popq</span>  %rdx		<span style=color:#75715e># len &gt; 1?
</span><span style=color:#75715e></span>
	<span style=color:#a6e22e>jg</span> <span style=color:#66d9ef>Loop</span>			<span style=color:#75715e># if so, goto Loop:
</span><span style=color:#75715e></span>
Single:
	<span style=color:#a6e22e>andq</span> %rdx, %rdx
	<span style=color:#a6e22e>jle</span> <span style=color:#66d9ef>Done</span>
	<span style=color:#a6e22e>mrmovq</span> (%rdi),%r10
	<span style=color:#a6e22e>rmmovq</span> %r10, (%rsi)
	<span style=color:#a6e22e>andq</span> %r10, %r10
	<span style=color:#a6e22e>jle</span> <span style=color:#66d9ef>Done</span> 
	<span style=color:#75715e># irmovq $1, %r10
</span><span style=color:#75715e></span>	<span style=color:#75715e># addq %r10, %rax		# count++
</span><span style=color:#75715e></span>	<span style=color:#66d9ef>iaddq</span> <span style=color:#66d9ef>$1</span>, %rax
<span style=color:#75715e>##################################################################
</span><span style=color:#75715e></span><span style=color:#75715e># Do not modify the following section of code
</span><span style=color:#75715e></span><span style=color:#75715e># Function epilogue.
</span><span style=color:#75715e></span>Done:
	<span style=color:#a6e22e>ret</span>

</code></pre></div><p>至此,我们已经确认循环展开是有效的. 因此不妨使用4x1的循环展开. 同时我们删除了一些冗余的代码,最终达到了8.68的CPE.</p><p>分数为36.4/60.. 及格了&mldr;orz</p><p>完整代码可以参考<a href=https://github.com/111qqz/csapp-lab/blob/master/archlab/sim/pipe/ncopy.ys>ncopy.ys</a></p><p>然后接下来的优化方向.. 毕竟容易想到的是条件mov的指令..
但是条件mov指令应该主要控制分支跳转的代价比较大时,才会比较有用.而我们的程序应该不存在比较大的开销.</p><p>然后其他的就是.. pipe-full.hcl文件我们除了增加iaddq指令外还没修改过&mldr; 可能会有进一步的优化空间</p><hr><ul class=pager><li class=previous><a href=/2020/02/csapp-attacklab/ data-toggle=tooltip data-placement=top title="【施工完成】CSAPP attacklab">&larr;
Previous Post</a></li><li class=next><a href=/2020/03/tensorrt-model-compatibility-notes/ data-toggle=tooltip data-placement=top title="tensorRT 模型兼容性说明">Next
Post &rarr;</a></li></ul><div class=post-comment><span id=/2020/02/csapp-archlab/ class=leancloud_visitors data-flag-title="【施工完成】CSAPP archlab"><span class=post-meta-item-text>访问量</span>
<span class=leancloud-visitors-count></span><p></p></span><div id=vcomments></div><script src=//cdn1.lncld.net/static/js/3.0.4/av-min.js></script><script src=//unpkg.com/valine/dist/Valine.min.js></script><script type=text/javascript>new Valine({el:'#vcomments',appId:'UzhnsgbPvx1RFb2kNXUHpPtf-gzGzoHsz',appKey:'OXOvoYGuwMv70Os5GOgaGEWT',notify:true,verify:false,avatar:'retro',placeholder:'说点什么吧...',visitor:true});</script></div></div><div class="col-lg-8 col-lg-offset-2
col-md-10 col-md-offset-1
sidebar-container"><section><hr class="hidden-sm hidden-xs"><h5><a href=/tags/>FEATURED TAGS</a></h5><div class=tags><a href=/tags/bfs title=bfs>bfs</a>
<a href=/tags/binary-search title=binary-search>binary-search</a>
<a href=/tags/brute-force title=brute-force>brute-force</a>
<a href=/tags/dfs title=dfs>dfs</a>
<a href=/tags/dp title=dp>dp</a>
<a href=/tags/greedy title=greedy>greedy</a>
<a href=/tags/kmp title=kmp>kmp</a>
<a href=/tags/leetcode title=leetcode>leetcode</a>
<a href=/tags/math title=math>math</a>
<a href=/tags/number-theory title=number-theory>number-theory</a>
<a href=/tags/rmq title=rmq>rmq</a>
<a href=/tags/stl title=stl>stl</a>
<a href=/tags/%E5%89%8D%E7%BC%80%E5%92%8C title=前缀和>前缀和</a>
<a href=/tags/%E5%8D%9A%E5%BC%88%E8%AE%BA title=博弈论>博弈论</a>
<a href=/tags/%E5%9B%BE%E8%AE%BA title=图论>图论</a>
<a href=/tags/%E5%BF%AB%E9%80%9F%E5%B9%82 title=快速幂>快速幂</a>
<a href=/tags/%E6%95%B0%E4%BD%8Ddp title=数位dp>数位dp</a>
<a href=/tags/%E6%9E%84%E9%80%A0 title=构造>构造</a>
<a href=/tags/%E6%A0%91%E7%8A%B6%E6%95%B0%E7%BB%84 title=树状数组>树状数组</a>
<a href=/tags/%E6%A8%A1%E6%8B%9F title=模拟>模拟</a>
<a href=/tags/%E6%AF%8D%E5%87%BD%E6%95%B0 title=母函数>母函数</a>
<a href=/tags/%E7%9F%A9%E9%98%B5 title=矩阵>矩阵</a>
<a href=/tags/%E7%BA%BF%E6%AE%B5%E6%A0%91 title=线段树>线段树</a>
<a href=/tags/%E8%AE%A1%E7%AE%97%E5%87%A0%E4%BD%95 title=计算几何>计算几何</a></div></section><section><hr><h5>FRIENDS</h5><ul class=list-inline><li><a target=_blank href=https://111qqz.com>111qqz的wordpress博客</a></li></ul></section></div></div></div></article><footer><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center"><li><a href rel=alternate type=application/rss+xml title=111qqz的小窝><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-rss fa-stack-1x fa-inverse"></i></span></a></li><li><a href=mailto:hust.111qqz@gmail.com><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-envelope fa-stack-1x fa-inverse"></i></span></a></li><li><a target=_blank href=/img/wechat.jpg><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-wechat fa-stack-1x fa-inverse"></i></span></a></li><li><a target=_blank href=https://github.com/111qqz/><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-github fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="copyright text-muted">Copyright &copy; 111qqz的小窝 2022<br><a href=https://beian.miit.gov.cn/>粤ICP备18103363号</a><br><a href=https://themes.gohugo.io/hugo-theme-cleanwhite>CleanWhite Hugo Theme</a> by <a href=https://zhaohuabing.com>Huabing</a> |
<iframe style=margin-left:2px;margin-bottom:-5px frameborder=0 scrolling=0 width=100px height=20px src="https://ghbtns.com/github-btn.html?user=zhaohuabing&repo=hugo-theme-cleanwhite&type=star&count=true"></iframe></p></div></div></div></footer><script>function async(u,c){var d=document,t='script',o=d.createElement(t),s=d.getElementsByTagName(t)[0];o.src=u;if(c){o.addEventListener('load',function(e){c(null,e);},false);}
s.parentNode.insertBefore(o,s);}</script><script>if($('#tag_cloud').length!==0){async("/js/jquery.tagcloud.js",function(){$.fn.tagcloud.defaults={color:{start:'#bbbbee',end:'#0085a1'},};$('#tag_cloud a').tagcloud();})}</script><script>async("https://cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.js",function(){var $nav=document.querySelector("nav");if($nav)FastClick.attach($nav);})</script></body></html>